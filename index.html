<!DOCTYPE html>
<html lang="et">
<head>
  <meta charset="UTF-8" />
  <title>Hispaania keel – Kehaosad, numbrid, päevad ja suunad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- PWA & iOS asjad -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="ES õppeäpp" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <link rel="manifest" href="manifest.json" />

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 12px;
    }
    h1, h2, h3 {
      text-align: center;
    }
    button {
      padding: 10px 16px;
      margin: 6px 4px;
      font-size: 16px;
      cursor: pointer;
    }
    input[type="text"] {
      width: 100%;
      padding: 8px;
      font-size: 16px;
      margin: 8px 0;
    }
    #estonian-word {
      font-size: 22px;
      font-weight: bold;
      margin: 12px 0;
    }
    #feedback {
      margin-top: 10px;
      font-size: 18px;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table, th, td {
      border: 1px solid #888;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    th {
      background: #f0f0f0;
    }
    #quiz-area {
      margin-top: 20px;
    }
    #mode-select {
      text-align: center;
      margin-bottom: 10px;
    }
    #mode-select p {
      margin-bottom: 8px;
    }
    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    #top-bar-title {
      flex: 1;
      text-align: center;
      font-weight: bold;
    }
    .correct-row {
      background-color: #d4edda; /* hele roheline */
    }
    .wrong-row {
      background-color: #f8d7da; /* hele punane */
    }
    #last-result {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Hispaania keel – Kehaosad, numbrid, päevad ja suunad</h1>

  <div id="mode-select">
    <p>Vali blokk, mida harjutada:</p>
    <button id="mode-body">Kehaosad</button>
    <button id="mode-numbers">Numbrid (1–100, sajad, tuhanded)</button>
    <button id="mode-days">Päevad ja suunad</button>
  </div>

  <div id="quiz-area" style="display:none;">
    <div id="top-bar">
      <button id="restart-btn">Alusta uuesti</button>
      <div id="top-bar-title"><span id="mode-title"></span></div>
      <button id="cancel-btn">Katkesta</button>
    </div>

    <p id="instructions"></p>

    <div id="estonian-word">Vajuta “Järgmine”</div>

    <label>
      Sinu vastus hispaania keeles:
      <input type="text" id="answer-input" autocomplete="off" />
    </label>
    <br />

    <button id="next-btn">Järgmine</button>
    <button id="check-btn">Kontrolli</button>

    <div id="feedback"></div>

    <div id="last-result"></div>
  </div>

  <div id="summary"></div>

  <script>
    // -------- ANDMED --------

    const bodyWords = [
      { et: "pea", es: ["cabeza", "la cabeza", "cabecita", "el coco"] },
      { et: "silm", es: ["ojo", "el ojo", "ojito", "ojitos"] },
      { et: "nina", es: ["nariz", "la nariz", "naricita", "napia"] },
      { et: "suu", es: ["boca", "la boca", "boquita"] },
      { et: "hammas", es: ["diente", "el diente", "dientecito", "muela", "la muela"] },
      { et: "keel", es: ["lengua", "la lengua", "lengüita", "lenguita"] },
      { et: "kõrv", es: ["oreja", "la oreja", "orejita", "orejitas"] },
      { et: "kael", es: ["cuello", "el cuello", "cuellito"] },
      { et: "õlg", es: ["hombro", "el hombro", "hombrito"] },
      { et: "käsi (randmest allpool)", es: ["mano", "la mano", "manita", "manitas"] },
      { et: "sõrm", es: ["dedo", "el dedo", "dedito", "deditos"] },
      { et: "rind", es: ["pecho", "el pecho", "pechito", "pechitos"] },
      { et: "selg", es: ["espalda", "la espalda", "espaldita"] },
      {
        et: "kõht",
        es: [
          "barriga", "la barriga",
          "estomago", "estómago",
          "el estomago", "el estómago",
          "panza", "la panza", "pancita", "tripita"
        ]
      },
      { et: "jalg", es: ["pierna", "la pierna", "piernita", "piernitas"] },
      { et: "põlv", es: ["rodilla", "la rodilla", "rodillita"] },
      {
        et: "varvas",
        es: [
          "dedo del pie", "el dedo del pie",
          "deditos del pie", "deditos"
        ]
      },
      {
        et: "tagumik",
        es: [
          "culo", "el culo",
          "trasero", "el trasero",
          "pompis",
          "nalgas", "las nalgas"
        ]
      },
      { et: "naeratus", es: ["sonrisa", "la sonrisa", "sonrisita"] },
      { et: "ripsmed", es: ["pestañas", "las pestañas", "pestañitas"] },
      { et: "huuled", es: ["labios", "los labios", "labiecitos"] },
      { et: "põsk", es: ["mejilla", "la mejilla", "cachete", "el cachete", "cachetito"] },
      { et: "põsed", es: ["mejillas", "las mejillas", "cachetes", "los cachetes"] },
      { et: "kulm", es: ["ceja", "la ceja", "cejita"] },
      { et: "kulmud", es: ["cejas", "las cejas", "cejitas"] },
      {
        et: "meeste suguelund",
        es: [
          "pene", "el pene",
          "pito",
          "verga",
          "mi cosita",
          "pajarito"
        ]
      },
      {
        et: "naiste suguelund",
        es: [
          "vagina", "la vagina",
          "chocho",
          "chucha",
          "pucha",
          "cosita",
          "chuchita"
        ]
      }
    ];

    const daysAndDirs = [
      { et: "esmaspäev", es: ["lunes", "el lunes"] },
      { et: "teisipäev", es: ["martes", "el martes"] },
      { et: "kolmapäev", es: ["miércoles", "miercoles", "el miércoles", "el miercoles"] },
      { et: "neljapäev", es: ["jueves", "el jueves"] },
      { et: "reede", es: ["viernes", "el viernes"] },
      { et: "laupäev", es: ["sábado", "sabado", "el sábado", "el sabado"] },
      { et: "pühapäev", es: ["domingo", "el domingo"] },

      { et: "põhi", es: ["norte", "el norte"] },
      { et: "lõuna", es: ["sur", "el sur"] },
      { et: "ida", es: ["este", "el este"] },
      { et: "lääs", es: ["oeste", "el oeste"] },

      { et: "üles", es: ["arriba", "hacia arriba"] },
      // parandatud: 'hacia alla' -> 'hacia abajo' (õige vastus sõnale "alla")
      { et: "alla", es: ["abajo", "hacia abajo"] },
      { et: "vasakule", es: ["a la izquierda", "izquierda"] },
      { et: "paremale", es: ["a la derecha", "derecha"] },
      { et: "edasi", es: ["adelante", "hacia adelante", "recto", "sigue recto"] },
      { et: "tagasi", es: ["atrás", "atras", "hacia atrás", "hacia atras"] }
    ];

    function spanishNumber(n) {
      n = Number(n);
      if (!Number.isInteger(n) || n <= 0 || n > 9999) return String(n);

      const units = ["", "uno", "dos", "tres", "cuatro", "cinco", "seis", "siete", "ocho", "nueve"];
      const teens = { 10: "diez", 11: "once", 12: "doce", 13: "trece", 14: "catorce", 15: "quince" };
      const tensWords = {
        2: "veinte",
        3: "treinta",
        4: "cuarenta",
        5: "cincuenta",
        6: "sesenta",
        7: "setenta",
        8: "ochenta",
        9: "noventa"
      };
      const hundredsWords = {
        1: "ciento",
        2: "doscientos",
        3: "trescientos",
        4: "cuatrocientos",
        5: "quinientos",
        6: "seiscientos",
        7: "setecientos",
        8: "ochocientos",
        9: "novecientos"
      };

      if (n <= 9) return units[n];
      if (n >= 10 && n <= 15) return teens[n];
      if (n < 20) return "dieci" + units[n - 10];

      if (n === 20) return "veinte";
      if (n > 20 && n < 30) return "veinti" + units[n - 20];

      if (n < 100) {
        const t = Math.floor(n / 10);
        const u = n % 10;
        if (u === 0) return tensWords[t];
        return tensWords[t] + " y " + units[u];
      }

      if (n === 100) return "cien";
      if (n < 200) return "ciento " + spanishNumber(n - 100);

      if (n < 1000) {
        const h = Math.floor(n / 100);
        const r = n % 100;
        if (r === 0) return hundredsWords[h];
        return hundredsWords[h] + " " + spanishNumber(r);
      }

      if (n === 1000) return "mil";
      if (n < 2000) return "mil " + spanishNumber(n - 1000);

      const thousands = Math.floor(n / 1000);
      const rem = n % 1000;
      const thousandsPart = spanishNumber(thousands) + " mil";
      if (rem === 0) return thousandsPart;
      return thousandsPart + " " + spanishNumber(rem);
    }

    function buildNumberWords() {
      const pool = [];
      for (let i = 1; i <= 100; i++) pool.push(i);
      for (let i = 1; i <= 9; i++) pool.push(i * 100);
      for (let i = 1; i <= 9; i++) pool.push(i * 1000);

      const shuffled = pool.sort(function() { return Math.random() - 0.5; });
      const selected = shuffled.slice(0, 10);

      return selected.map(function(n) {
        const word = spanishNumber(n);
        return {
          et: String(n),
          es: [word, String(n)]
        };
      });
    }

    // -------- MUUTUJAD --------

    let currentWords = [];
    let currentWord = null;
    let usedIndices = [];
    let results = [];
    let currentMode = null;
    let lastResult = null; // ainult VIIMANE vastatud küsimus

    // -------- ABI --------

    function normalize(str) {
      // kaitse null/undefined eest
      return String(str || "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .trim();
    }

    function speak(text, lang) {
      if (!("speechSynthesis" in window)) return;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = lang;
      window.speechSynthesis.speak(utterance);
    }

    function showModeSelect() {
      document.getElementById("mode-select").style.display = "block";
      document.getElementById("quiz-area").style.display = "none";
    }

    function renderLastResult() {
      const div = document.getElementById("last-result");
      if (!lastResult) {
        div.innerHTML = "";
        return;
      }
      const rowClass = lastResult.ok ? "correct-row" : "wrong-row";
      let html = "<h3>Eelmine küsimus</h3>";
      html += '<table><tr><th>Eesti</th><th>Sinu vastus</th><th>Õige(d)</th></tr>';
      html += `<tr class="${rowClass}">
                 <td>${lastResult.et}</td>
                 <td>${lastResult.user}</td>
                 <td>${lastResult.correct}</td>
               </tr>`;
      html += "</table>";
      div.innerHTML = html;
    }

    function startMode(mode) {
      currentMode = mode;
      usedIndices = [];
      results = [];
      lastResult = null;
      currentWord = null;
      document.getElementById("feedback").textContent = "";
      document.getElementById("answer-input").value = "";
      document.getElementById("summary").innerHTML = "";
      renderLastResult();

      if (mode === "body") {
        currentWords = bodyWords.slice();
        document.getElementById("mode-title").textContent = "Kehaosad";
        document.getElementById("instructions").textContent =
          "Kuvatakse kehaosa eesti keeles. Kirjuta hispaaniakeelne vastus (võid kasutada ka slängi). Kõik sõnad küsitakse korra.";
      } else if (mode === "numbers") {
        currentWords = buildNumberWords();
        document.getElementById("mode-title").textContent = "Numbrid";
        document.getElementById("instructions").textContent =
          "Küsitakse 10 erinevat numbrit (1–100, sajad, tuhanded). Võid vastata hispaania sõnaga või lihtsalt numbriga.";
      } else if (mode === "days") {
        currentWords = daysAndDirs.slice();
        document.getElementById("mode-title").textContent = "Päevad ja suunad";
        document.getElementById("instructions").textContent =
          "Küsitakse nädalapäevi, ilmakaari ja suundi (üles, alla, vasakule, paremale, edasi, tagasi). Kirjita hispaaniakeelne vastus.";
      }

      document.getElementById("mode-select").style.display = "none";
      document.getElementById("quiz-area").style.display = "block";

      pickNewWord();
    }

    function pickNewWord() {
      if (!currentWords.length) return;

      if (usedIndices.length === currentWords.length) {
        showSummary();
        return;
      }

      let index;
      do {
        index = Math.floor(Math.random() * currentWords.length);
      } while (usedIndices.includes(index));

      usedIndices.push(index);
      currentWord = currentWords[index];

      document.getElementById("estonian-word").textContent = currentWord.et;
      document.getElementById("answer-input").value = "";
      document.getElementById("feedback").textContent = "";
      document.getElementById("answer-input").focus();
    }

    function checkAnswer() {
      if (!currentWord) return;

      const inputRaw = document.getElementById("answer-input").value;
      const input = normalize(inputRaw);
      if (!input) {
        document.getElementById("feedback").textContent =
          "Kirjita palun vastus enne kontrollimist.";
        return;
      }

      const correctNormalized = currentWord.es.map(normalize);
      const isCorrect = correctNormalized.includes(input);

      const feedback = document.getElementById("feedback");
      const correctText = currentWord.es.join(", ");

      const row = {
        et: currentWord.et,
        user: inputRaw,
        correct: correctText,
        ok: isCorrect
      };

      results.push(row);
      lastResult = row;
      renderLastResult();

      if (isCorrect) {
        feedback.textContent = "ÕIGE! ✅ – " + correctText;
      } else {
        feedback.textContent = "❌ Vale. Õige(d): " + correctText;
      }

      speak(currentWord.es[0], "es-ES");
    }

    function renderSummary() {
      const summaryDiv = document.getElementById("summary");
      summaryDiv.innerHTML = "";

      if (!results.length) {
        summaryDiv.innerHTML = "<h2>Kokkuvõte</h2><p>Ühtegi vastust ei jõudnud anda.</p>";
        return;
      }

      const correctCount = results.filter(r => r.ok).length;
      let html = "<h2>Kokkuvõte</h2>" +
                 "<p>Õigeid vastuseid: " + correctCount + " / " + results.length + "</p>";

      html += "<table><tr><th>Eesti sõna / number</th><th>Sinu vastus</th><th>Õige(d)</th></tr>";

      results.forEach(function(row) {
        const rowClass = row.ok ? "correct-row" : "wrong-row";
        html += '<tr class="' + rowClass + '">';
        html += "<td>" + row.et + "</td>";
        html += "<td>" + row.user + "</td>";
        html += "<td>" + row.correct + "</td>";
        html += "</tr>";
      });

      html += "</table>";

      summaryDiv.innerHTML = html;
    }

    function showSummary() {
      // Näita kokkuvõtet seni antud vastustest ja vii kasutaja tagasi blokkide valikusse
      document.getElementById("quiz-area").style.display = "none";
      renderSummary();
      document.getElementById("mode-select").style.display = "block";
    }

    function restartApp() {
      // Kui soovid kustutada kogu seansi (nt kui kasutaja valib uue blokki), 
      // startMode funktsioon teeb selle juba ette kui uus mood alustatakse.
      currentMode = null;
      currentWords = [];
      usedIndices = [];
      results = [];
      lastResult = null;
      currentWord = null;
      document.getElementById("feedback").textContent = "";
      document.getElementById("answer-input").value = "";
      document.getElementById("summary").innerHTML = "";
      document.getElementById("estonian-word").textContent =
        "Vali uuesti blokk ja vajuta “Järgmine”.";
      renderLastResult();
      showModeSelect();
    }

    // -------- NUPUD --------

    const modeBodyBtn = document.getElementById("mode-body");
    const modeNumbersBtn = document.getElementById("mode-numbers");
    const modeDaysBtn = document.getElementById("mode-days");
    const nextBtn = document.getElementById("next-btn");
    const checkBtn = document.getElementById("check-btn");
    const restartBtn = document.getElementById("restart-btn");
    const cancelBtn = document.getElementById("cancel-btn");
    const answerInput = document.getElementById("answer-input");

    modeBodyBtn.onclick = function() { startMode("body"); };
    modeNumbersBtn.onclick = function() { startMode("numbers"); };
    modeDaysBtn.onclick = function() { startMode("days"); };
    nextBtn.onclick = function() { pickNewWord(); };
    checkBtn.onclick = function() { checkAnswer(); };
    // nüüd: Alusta uuesti näitab kokkuvõtet seni antud vastustest (sama nagu Katkesta)
    restartBtn.onclick = function() { showSummary(); };
    // Katkesta: näita kokkuvõtet seni antud vastustest
    cancelBtn.onclick = function() { showSummary(); };

    answerInput.addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        checkAnswer();
      }
    });

    // PWA service worker
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function() {
        navigator.serviceWorker.register("service-worker.js").catch(function(e){console.error(e);});
      });
    }
  </script>
</body>
</html>